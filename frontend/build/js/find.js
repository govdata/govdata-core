var root=this;
define(["gov","common/location","common/timedate","jquery","underscore","underscore.strings","jquery.hotkeys","ui.searchbar","ui.query","ui.findresults","ui.resultsview","jquery.masonry","ui.statehandler","ui.dict"],function(o,w){var d={};d.autocompleteCache={};d.submit=function(a,b){var c={q:"",rows:100,"facet.field":["sourceSpec","datasetTight","dateDivisionsTight","spatialDivisionsTight"],facet:"true",fl:"mongoID,mongoText,sourceSpec,query,volume,topic,collectionName"};$.extend(true,c,a);$.ajax({url:o.API_URL+
"/search",dataType:"jsonp",data:c,traditional:true,success:function(e){b(e)}})};d.getMetadata=function(a,b,c){a=[{action:"find",args:[{name:{$in:_.uniq(_.map(a,function(e){return e.collectionName[0]}))}}],kargs:{fields:["name","metadata.source"]}}];a={querySequence:JSON.stringify(a)};$.extend(true,a,c);$.ajax({url:o.API_URL+"/metadata",dataType:"jsonp",data:a,success:function(e){var k={};for(i in e){var h=e[i];k[h.name]=h.metadata}b(k)}})};same_as=function(a,b,c){return c in a&c in b&a[c]==b[c]?"sameVal":
"diffVal"};make_value=function(a,b){return b=="Location"?w.phrase(a):a};upperFirst=function(a){return a[0].toUpperCase()+a.slice(1)};d.resultRenderer=function(a,b,c){var e=a.sourceSpecParsed,k;if(c===undefined)c={};if(c.sourceSpecParsed){k=c.sourceSpecParsed;prev_query=c.queryParsed}else{k={};prev_query={}}b=(b===0?[]:b==="QUERY"?_(e).keys():_(e).keys().slice(b)).map(function(f){return"<div class='sourceElement "+same_as(e,k,f)+"'><span class='sourceKey' id='"+f+"'>"+upperFirst(f)+"</span>: <span class='sourceVal'>"+
e[f]+"</span></div>"}).join("");var h=a.queryParsed;c=_(h).keys().map(function(f){return"<div class='queryElement "+same_as(h,prev_query,f)+"'><span class='queryKey' id='"+f+"'>"+upperFirst(f)+"</span>: <span class='queryVal'>"+make_value(h[f],f)+"</span></div>"}).join("");b='<div class="sourceBox">'+b+"</div>";c='<div class="queryBox">'+c+"</div>";var l;l=a.volume!==undefined?'<div class="numResults">'+a.volume[0]+"</div>":"";h=a.queryParsed||{};h=JSON.stringify(h);if(a.collections===undefined)a.collections=
[a.collection];var m="<div>";_.each(a.collections,function(f){f=a.collections.length>1?'<div><a href="'+o.API_URL+"/data?collection="+f+"&query="+encodeURI(h)+'">Get the data for '+f+" &rarr;</a></div>":'<div><a href="'+o.API_URL+"/data?collection="+f+"&query="+encodeURI(h)+'">Get the data &rarr;</a></div>';m+=f});m+="</div>";return'<div class="resultBox"><div class="innerResultBox">'+b+c+m+l+"</div></div>"};dictIntersect=function(a,b){$.each(b,function(c,e){c in a&&!_.isEqual(a[c],e)&&delete a[c]});
$.each(a,function(c){c in b||delete a[c]})};dictDiff=function(a,b){$.each(b,function(c,e){_.isEqual(a[c],e)&&delete a[c]})};computeCommons=function(a){var b={sourceSpecParsed:_.clone(a[0].sourceSpecParsed),queryParsed:_.clone(a[0].queryParsed)};$.each(a.slice(1),function(c,e){dictIntersect(b.sourceSpecParsed,_.clone(e.sourceSpecParsed));dictIntersect(b.queryParsed,_.clone(e.queryParsed))});$.each(a,function(c,e){dictDiff(e.sourceSpecParsed,b.sourceSpecParsed);dictDiff(e.queryParsed,b.queryParsed)});
b.collections=[];$.each(a,function(c,e){_.include(b.collections,e.collection)===false&&b.collections.push(e.collection)});return b};reduceDuplicates=function(a){var b=[],c,e;$.each(a,function(k,h){c=true;$.each(a,function(l,m){if(c)if(h.volume[0]==m.volume[0]&&_.isEqual(h.sourceSpecParsed,m.sourceSpecParsed)&&k!=l){e=true;$.each(m.queryParsed,function(f,n){f in h.queryParsed&&_.isEqual(h.queryParsed[f],n)||(e=false)});if(e)c=false}});c&&b.push(k)});return _.map(b,function(k){return a[k]})};d.resultsRenderer=
function(a,b,c,e,k){var h=_.keys(JSON.parse(b[0].sourceSpec[0]));a.find(".keyLabel .chooserSubElement").unbind("click");a.find(".keyLabel .chooserSubElement").click(function(j){var g=parseInt(j.currentTarget.id),p=d.query.items.slice(0);g=h[g];j=$(j.currentTarget).find(".value").text();var q=d.query.filteritems;q.push(g+':"'+j+'"');d.query.update({qval:p,fqval:q});$(root).data().statehandler.changestate()});var l=[],m={};$.each(b,function(j,g){m={sourceSpecParsed:JSON.parse(g.sourceSpec[0]),queryParsed:JSON.parse(g.query[0]),
volume:g.volume,title:g.title,collection:g.collectionName[0]};l.push(m)});l=reduceDuplicates(l);e=computeCommons(l);var f,n,r,t=[],u=[];for(n in l){r=l[n];if(_.isEqual(r.sourceSpecParsed,{})&&_.isEqual(r.queryParsed,{})){if(r.volume!==undefined){f=r.volume;u.push(n)}}else t.push(n)}if(!_.isEqual(u,[])){n=c;if(_.keys(e.sourceSpecParsed).len==k.split("|").len&&_.isEqual(e.queryParsed,{}))n=c-1;c=$("<div class='commonBox'><div class='commonText'>All Data for: </div></div>").appendTo(a);l=_.map(t,function(j){return l[j]});
e.volume=[f+" records"];$(d.resultRenderer(e,n)).appendTo(c).addClass("commonResult")}var s=$("<div class='resultMason'></div>").appendTo(a);$.each(l,function(j,g){s.append(d.resultRenderer(g,-1,j>0?b[j-1]:{}))});s.masonry({columnWidth:230,singleMode:true,itemSelector:".resultBox",resizeable:true});$(".sourceElement").unbind("click");$(".sourceElement").click(function(j){var g=$(j.currentTarget);j=d.query.items.slice(0);var p=g.find(".sourceKey")[0].id;g=g.find(".sourceVal").text();var q=d.query.filteritems;
q.push(p+':"'+g+'"');d.query.update({qval:j,fqval:q});$(root).data().statehandler.changestate()});$(".queryElement").unbind("click");$(".queryElement").click(function(j){var g=$(j.currentTarget);j=d.query.items.slice(0);var p=g.find(".queryKey")[0].id;g=g.find(".queryVal").text();j.push('"'+p+"="+g+'"');d.query.update({qval:j});$(root).data().statehandler.changestate()});return s};d.addSearchBar=function(){var a={query:d.query,autocomplete:{minLength:2,source:function(b,c){var e=b.term;if(e in d.autocompleteCache)c(d.autocompleteCache[e]);
else lastXhr=$.ajax({url:o.API_URL+"/terms",data:{"terms.fl":"autocomplete","terms.sort":"index","terms.prefix":b.term,omitHeader:true},dataType:"jsonp",success:function(k,h,l){k=_.select(k.terms[1],function(m,f){if(f%2==0)return m});d.autocompleteCache[e]=k;l===lastXhr&&c(k)}})}}};return $("<div id='searchbar'></div>").appendTo("#subHeader").searchbar({query:d.query,autocomplete:a.autocomplete})};var v=function(a){self=this;self.items=a;self.value=function(){return this.items};self.update=function(b){self=
this;self.items=b};remove=function(b){self=this;delete self.items[b]};add=function(b,c){self=this;self.items[b]=c};return self};v.prototype={};d.load=function(a,b){d.query=$(root).query({submitFn:d.submit,newData:function(c,e){d.results.newResults(e)}}).data("query");d.collapsedict=$(root).dict({items:{" ":0},prefix:"collapsedict"}).data("dict");d.hidedict=v({" ":false});d.statehandler=$(root).statehandler({objects:{query:d.query,collapsedict:d.collapsedict,hidedict:d.hidedict}}).data("statehandler");
$("#subHeader").remove();$("<div id='subHeader'></div>").appendTo("#content");$("#searchbar").remove();d.sb=d.addSearchBar();d.statehandler.setstate(b);d.results=$(root).findresults({metadataFn:d.getMetadata}).data("findresults");$("#resultsView").remove();d.resultsView=$("<div id='resultsView'></div>").appendTo("#content").resultsview({dataHandler:d.results,resultsRenderer:d.resultsRenderer,collapsedict:d.collapsedict,hidedict:d.hidedict,query:d.query})};return d});