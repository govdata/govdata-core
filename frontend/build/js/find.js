var root=this;
define(["gov","common/location","common/timedate","jquery","underscore","underscore.strings","jquery.hotkeys","ui.searchbar","ui.query","ui.findresults","ui.resultsview","jquery.masonry","ui.statehandler","ui.dict"],function(r,w){var d={};d.autocompleteCache={};d.submit=function(a,c){var b={q:"",rows:100,"facet.field":["sourceSpec","datasetTight","dateDivisionsTight","spatialDivisionsTight"],facet:"true",fl:"mongoID,mongoText,sourceSpec,query,volume,topic,collectionName"};$.extend(true,b,a);$.ajax({url:r.API_URL+
"/search",dataType:"jsonp",data:b,traditional:true,success:function(e){c(e)}})};d.getMetadata=function(a,c,b){a=[{action:"find",args:[{name:{$in:_.uniq(_.map(a,function(e){return e.collectionName[0]}))}}],kargs:{fields:["name","metadata.source"]}}];a={querySequence:JSON.stringify(a)};$.extend(true,a,b);$.ajax({url:r.API_URL+"/metadata",dataType:"jsonp",data:a,success:function(e){var h={};for(i in e){var j=e[i];h[j.name]=j.metadata}c(h)}})};same_as=function(a,c,b){return b in a&b in c&a[b]==c[b]?"sameVal":
"diffVal"};make_value=function(a,c){return c=="Location"?w.phrase(a):a};upperFirst=function(a){return a[0].toUpperCase()+a.slice(1)};d.resultRenderer=function(a,c,b){var e=a.sourceSpecParsed,h;if(b===undefined)b={};if(b.sourceSpecParsed){h=b.sourceSpecParsed;prev_query=b.queryParsed}else{h={};prev_query={}}c=(c===0?[]:c==="QUERY"?_(e).keys():_(e).keys().slice(c)).map(function(k){return"<div class='sourceElement "+same_as(e,h,k)+"'><span class='sourceKey' id='"+k+"'>"+upperFirst(k)+"</span>: <span class='sourceVal'>"+
e[k]+"</span></div>"}).join("");var j=a.queryParsed;b=_(j).keys().map(function(k){return"<div class='queryElement "+same_as(j,prev_query,k)+"'><span class='queryKey' id='"+k+"'>"+upperFirst(k)+"</span>: <span class='queryVal'>"+make_value(j[k],k)+"</span></div>"}).join("");c='<div class="sourceBox">'+c+"</div>";b='<div class="queryBox">'+b+"</div>";var l;l=a.volume!==undefined?'<div class="numResults">'+a.volume[0]+"</div>":"";var m=a.collection||"";j=a.queryParsed||{};j=JSON.stringify(j);a='<div><a href="'+
r.API_URL+"/data?collection="+m+"&query="+encodeURI(j)+'">JSONP</a></div>';return'<div class="resultBox"><div class="innerResultBox">'+c+b+a+l+"</div></div>"};dictIntersect=function(a,c){$.each(c,function(b,e){b in a&&!_.isEqual(a[b],e)&&delete a[b]});$.each(a,function(b){b in c||delete a[b]})};dictDiff=function(a,c){$.each(c,function(b,e){_.isEqual(a[b],e)&&delete a[b]})};computeCommons=function(a){var c={sourceSpecParsed:_.clone(a[0].sourceSpecParsed),queryParsed:_.clone(a[0].queryParsed)};$.each(a.slice(1),
function(b,e){dictIntersect(c.sourceSpecParsed,_.clone(e.sourceSpecParsed));dictIntersect(c.queryParsed,_.clone(e.queryParsed))});$.each(a,function(b,e){dictDiff(e.sourceSpecParsed,c.sourceSpecParsed);dictDiff(e.queryParsed,c.queryParsed)});return c};reduceDuplicates=function(a){var c=[],b,e;$.each(a,function(h,j){b=true;$.each(a,function(l,m){if(b)if(j.volume[0]==m.volume[0]&&_.isEqual(j.sourceSpecParsed,m.sourceSpecParsed)&&h!=l){e=true;$.each(m.queryParsed,function(k,n){k in j.queryParsed&&_.isEqual(j.queryParsed[k],
n)||(e=false)});if(e)b=false}});b&&c.push(h)});return _.map(c,function(h){return a[h]})};d.resultsRenderer=function(a,c,b,e,h){var j=_.keys(JSON.parse(c[0].sourceSpec[0]));a.find(".keyLabel .chooserSubElement").unbind("click");a.find(".keyLabel .chooserSubElement").click(function(g){var f=parseInt(g.currentTarget.id),o=d.query.items.slice(0);f=j[f];g=$(g.currentTarget).find(".value").text();var p=d.query.filteritems;p.push(f+':"'+g+'"');d.query.update({qval:o,fqval:p});$(root).data().statehandler.changestate()});
var l=[],m={};$.each(c,function(g,f){m={sourceSpecParsed:JSON.parse(f.sourceSpec[0]),queryParsed:JSON.parse(f.query[0]),volume:f.volume,title:f.title,collection:f.collectionName[0]};l.push(m)});l=reduceDuplicates(l);e=computeCommons(l);var k,n,q,t=[],u=[];for(n in l){q=l[n];if(_.isEqual(q.sourceSpecParsed,{})&&_.isEqual(q.queryParsed,{})){if(q.volume!==undefined){k=q.volume;u.push(n)}}else t.push(n)}if(!_.isEqual(u,[])){n=b;if(_.keys(e.sourceSpecParsed).len==h.split("|").len&&_.isEqual(e.queryParsed,
{}))n=b-1;b=$("<div class='commonBox'><div class='commonText'>All Data for: </div></div>").appendTo(a);l=_.map(t,function(g){return l[g]});e.volume=[k+" records"];$(d.resultRenderer(e,n)).appendTo(b).addClass("commonResult")}var s=$("<div class='resultMason'></div>").appendTo(a);$.each(l,function(g,f){s.append(d.resultRenderer(f,-1,g>0?c[g-1]:{}))});s.masonry({columnWidth:230,singleMode:true,itemSelector:".resultBox",resizeable:true});$(".sourceElement").unbind("click");$(".sourceElement").click(function(g){var f=
$(g.currentTarget);g=d.query.items.slice(0);var o=f.find(".sourceKey")[0].id;f=f.find(".sourceVal").text();var p=d.query.filteritems;p.push(o+':"'+f+'"');d.query.update({qval:g,fqval:p});$(root).data().statehandler.changestate()});$(".queryElement").unbind("click");$(".queryElement").click(function(g){var f=$(g.currentTarget);g=d.query.items.slice(0);var o=f.find(".queryKey")[0].id;f=f.find(".queryVal").text();g.push('"'+o+"="+f+'"');d.query.update({qval:g});$(root).data().statehandler.changestate()});
return s};d.addSearchBar=function(){var a={query:d.query,autocomplete:{minLength:2,source:function(c,b){var e=c.term;if(e in d.autocompleteCache)b(d.autocompleteCache[e]);else lastXhr=$.ajax({url:r.API_URL+"/terms",data:{"terms.fl":"autocomplete","terms.sort":"index","terms.prefix":c.term,omitHeader:true},dataType:"jsonp",success:function(h,j,l){h=_.select(h.terms[1],function(m,k){if(k%2==0)return m});d.autocompleteCache[e]=h;l===lastXhr&&b(h)}})}}};return $("<div id='searchbar'></div>").appendTo("#subHeader").searchbar({query:d.query,
autocomplete:a.autocomplete})};var v=function(a){self=this;self.items=a;self.value=function(){return this.items};self.update=function(c){self=this;self.items=c};remove=function(c){self=this;delete self.items[c]};add=function(c,b){self=this;self.items[c]=b};return self};v.prototype={};d.load=function(a,c){d.query=$(root).query({submitFn:d.submit,newData:function(b,e){d.results.newResults(e)}}).data("query");d.collapsedict=$(root).dict({items:{" ":0},prefix:"collapsedict"}).data("dict");d.hidedict=
v({" ":false});d.statehandler=$(root).statehandler({objects:{query:d.query,collapsedict:d.collapsedict,hidedict:d.hidedict}}).data("statehandler");$("#subHeader").remove();$("<div id='subHeader'></div>").appendTo("#content");$("#searchbar").remove();d.sb=d.addSearchBar();d.statehandler.setstate(c);d.results=$(root).findresults({metadataFn:d.getMetadata}).data("findresults");$("#resultsView").remove();d.resultsView=$("<div id='resultsView'></div>").appendTo("#content").resultsview({dataHandler:d.results,
resultsRenderer:d.resultsRenderer,collapsedict:d.collapsedict,hidedict:d.hidedict,query:d.query})};return d});