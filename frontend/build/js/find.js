var root=this;
define(["gov","common/location","common/timedate","jquery","underscore","underscore.strings","jquery.hotkeys","ui.searchbar","ui.query","ui.findresults","ui.resultsview","jquery.masonry","ui.statehandler","ui.dict"],function(r,w){var c={};c.autocompleteCache={};c.submit=function(a,d){var b={q:"",rows:100,"facet.field":["sourceSpec","datasetTight","dateDivisionsTight","spatialDivisionsTight"],facet:"true",fl:"mongoID,mongoText,sourceSpec,query,volume,topic,collectionName"};$.extend(true,b,a);$.ajax({url:r.API_URL+
"/search",dataType:"jsonp",data:b,traditional:true,success:function(e){d(e)}})};c.getMetadata=function(a,d,b){a=[{action:"find",args:[{name:{$in:_.uniq(_.map(a,function(e){return e.collectionName[0]}))}}],kargs:{fields:["name","metadata.source"]}}];a={querySequence:JSON.stringify(a)};$.extend(true,a,b);$.ajax({url:r.API_URL+"/metadata",dataType:"jsonp",data:a,success:function(e){var j={};for(i in e){var k=e[i];j[k.name]=k.metadata}d(j)}})};same_as=function(a,d,b){return b in a&b in d&a[b]==d[b]?"sameVal":
"diffVal"};make_value=function(a,d){return d=="Location"?w.phrase(a):a};upperFirst=function(a){return a[0].toUpperCase()+a.slice(1)};c.resultRenderer=function(a,d,b){var e=a.sourceSpecParsed,j;if(b===undefined)b={};if(b.sourceSpecParsed){j=b.sourceSpecParsed;prev_query=b.queryParsed}else{j={};prev_query={}}d=(d===0?[]:d==="QUERY"?_(e).keys():_(e).keys().slice(d)).map(function(f){return"<div class='sourceElement "+same_as(e,j,f)+"'><span class='sourceKey' id='"+f+"'>"+upperFirst(f)+"</span>: <span class='sourceVal'>"+
e[f]+"</span></div>"}).join("");var k=a.queryParsed;b=_(k).keys().map(function(f){return"<div class='queryElement "+same_as(k,prev_query,f)+"'><span class='queryKey' id='"+f+"'>"+upperFirst(f)+"</span>: <span class='queryVal'>"+make_value(k[f],f)+"</span></div>"}).join("");return'<div class="resultBox"><div class="innerResultBox">'+('<div class="sourceBox">'+d+"</div>")+('<div class="queryBox">'+b+"</div>")+(a.volume!==undefined?'<div class="numResults">'+a.volume[0]+"</div>":"")+"</div></div>"};
dictIntersect=function(a,d){$.each(d,function(b,e){b in a&&!_.isEqual(a[b],e)&&delete a[b]});$.each(a,function(b){b in d||delete a[b]})};dictDiff=function(a,d){$.each(d,function(b,e){_.isEqual(a[b],e)&&delete a[b]})};computeCommons=function(a){var d={sourceSpecParsed:_.clone(a[0].sourceSpecParsed),queryParsed:_.clone(a[0].queryParsed)};$.each(a.slice(1),function(b,e){dictIntersect(d.sourceSpecParsed,_.clone(e.sourceSpecParsed));dictIntersect(d.queryParsed,_.clone(e.queryParsed))});$.each(a,function(b,
e){dictDiff(e.sourceSpecParsed,d.sourceSpecParsed);dictDiff(e.queryParsed,d.queryParsed)});return d};reduceDuplicates=function(a){var d=[],b,e;$.each(a,function(j,k){b=true;$.each(a,function(f,m){if(b)if(k.volume[0]==m.volume[0]&&_.isEqual(k.sourceSpecParsed,m.sourceSpecParsed)&&j!=f){e=true;$.each(m.queryParsed,function(n,l){n in k.queryParsed&&_.isEqual(k.queryParsed[n],l)||(e=false)});if(e)b=false}});b&&d.push(j)});return _.map(d,function(j){return a[j]})};c.resultsRenderer=function(a,d,b,e,j){var k=
_.keys(JSON.parse(d[0].sourceSpec[0]));a.find(".keyLabel .chooserSubElement").unbind("click");a.find(".keyLabel .chooserSubElement").click(function(h){var g=parseInt(h.currentTarget.id),o=c.query.items.slice(0);g=k[g];h=$(h.currentTarget).find(".value").text();var p=c.query.filteritems;p.push(g+':"'+h+'"');c.query.update({qval:o,fqval:p});$(root).data().statehandler.changestate()});var f=[],m={};$.each(d,function(h,g){m={sourceSpecParsed:JSON.parse(g.sourceSpec[0]),queryParsed:JSON.parse(g.query[0]),
volume:g.volume,title:g.title};f.push(m)});f=reduceDuplicates(f);e=computeCommons(f);var n,l,q,t=[],u=[];for(l in f){q=f[l];if(_.isEqual(q.sourceSpecParsed,{})&&_.isEqual(q.queryParsed,{})){if(q.volume!==undefined){n=q.volume;u.push(l)}}else t.push(l)}if(!_.isEqual(u,[])){l=b;if(_.keys(e.sourceSpecParsed).len==j.split("|").len&&_.isEqual(e.queryParsed,{}))l=b-1;b=$("<div class='commonBox'><div class='commonText'>All Data for: </div></div>").appendTo(a);f=_.map(t,function(h){return f[h]});e.volume=
[n+" records"];$(c.resultRenderer(e,l)).appendTo(b).addClass("commonResult")}var s=$("<div class='resultMason'></div>").appendTo(a);$.each(f,function(h,g){s.append(c.resultRenderer(g,-1,h>0?d[h-1]:{}))});s.masonry({columnWidth:230,singleMode:true,itemSelector:".resultBox",resizeable:true});$(".sourceElement").unbind("click");$(".sourceElement").click(function(h){var g=$(h.currentTarget);h=c.query.items.slice(0);var o=g.find(".sourceKey")[0].id;g=g.find(".sourceVal").text();var p=c.query.filteritems;
p.push(o+':"'+g+'"');c.query.update({qval:h,fqval:p});$(root).data().statehandler.changestate()});$(".queryElement").unbind("click");$(".queryElement").click(function(h){var g=$(h.currentTarget);h=c.query.items.slice(0);var o=g.find(".queryKey")[0].id;g=g.find(".queryVal").text();h.push('"'+o+"="+g+'"');c.query.update({qval:h});$(root).data().statehandler.changestate()});return s};c.addSearchBar=function(){var a={query:c.query,autocomplete:{minLength:2,source:function(d,b){var e=d.term;if(e in c.autocompleteCache)b(c.autocompleteCache[e]);
else lastXhr=$.ajax({url:r.API_URL+"/terms",data:{"terms.fl":"autocomplete","terms.sort":"index","terms.prefix":d.term,omitHeader:true},dataType:"jsonp",success:function(j,k,f){j=_.select(j.terms[1],function(m,n){if(n%2==0)return m});c.autocompleteCache[e]=j;f===lastXhr&&b(j)}})}}};return $("<div id='searchbar'></div>").appendTo("#subHeader").searchbar({query:c.query,autocomplete:a.autocomplete})};var v=function(a){self=this;self.items=a;self.value=function(){return this.items};self.update=function(d){self=
this;self.items=d};remove=function(d){self=this;delete self.items[d]};add=function(d,b){self=this;self.items[d]=b};return self};v.prototype={};c.load=function(a,d){c.query=$(root).query({submitFn:c.submit,newData:function(b,e){c.results.newResults(e)}}).data("query");c.collapsedict=$(root).dict({items:{" ":0},prefix:"collapsedict"}).data("dict");c.hidedict=v({" ":false});c.statehandler=$(root).statehandler({objects:{query:c.query,collapsedict:c.collapsedict,hidedict:c.hidedict}}).data("statehandler");
$("#subHeader").remove();$("<div id='subHeader'></div>").appendTo("#content");$("#searchbar").remove();c.sb=c.addSearchBar();c.statehandler.setstate(d);c.results=$(root).findresults({metadataFn:c.getMetadata}).data("findresults");$("#resultsView").remove();c.resultsView=$("<div id='resultsView'></div>").appendTo("#content").resultsview({dataHandler:c.results,resultsRenderer:c.resultsRenderer,collapsedict:c.collapsedict,hidedict:c.hidedict,query:c.query})};return c});