define(["utils","jquery","jquery-ui","ui.linearchooser","ui.clusterelement"],function(o){function v(p,a,j){var f={},b,c={},e,g;_.each(p,function(d){if(j===0)b=_.pluck(_.values(a[d.collectionName].source),"name").join("|");else if(j=="QUERY"){e=_.pluck(_.values(a[d.collectionName].source),"name").join("|");if(g!==undefined&&g.split("|").slice(0,-1).join("|")==e)b=g;else{if(e in c)c[e]+=1;else c[e]=0;b=e+"|"+c[e]}g=b}else b=_.pluck(_.values(a[d.collectionName].source).slice(0,j),"name").join("|");f[b]=
f[b]||[];f[b].push(d)});return f}function w(p,a,j,f,b,c,e,g){var d,q,l,k,m,n,r=$("<div class='elementContainer'></div>").appendTo(g.widget());$.each(p,function(h,s){q=a.items[h]||0;d=_.uniq(_.map(s,function(t){return t.collectionName[0]}));l=o.subdict(b,d);if(q===0){m=d.length>1?o.computeCommon(l,e):null;k=$("<div class='clusterElement'></div>").appendTo(r).clusterelement({key:h,results:s,common:m,start:c,collapse:e,hidedict:j,renderer:g.options.resultsRenderer,facet_dict:f})}else k=$("<div class='clusterView'></div>").appendTo(r).clusterview({key:h,
data:s,metadata:l,start:c,collapsedict:a,hidedict:j,resultsRenderer:g.options.resultsRenderer,facet_dict:f});n=h.replace(/ /g,"__");k.attr("id",n)});return r}$.widget("ui.clusterview",{options:{start:0},_create:function(){var p=this,a=this.options.key,j=this.options.data,f=this.options.metadata,b=this.options.collapsedict,c=this.options.hidedict,e=this.options.start,g=this.options.facet_dict,d,q,l=o.computeCommon(f,o.count(a,"|")),k=l[0],m=l[1];$.each(k,function(u,i){k[u]='<div class="innerClusterChooser value">'+
i[0].toUpperCase()+i.slice(1)+"</div>"});$.each(m,function(u,i){m[u]='<div class="innerClusterChooser value">'+i[0].toUpperCase()+i.slice(1)+"</div>"});l=$("<div class='topBar'></div>").appendTo(this.element);var n=c.items[a]||false;n=n===true?"keyLabel hide":"keyLabel";var r;r=a in g?" <span class='facet'>("+g[a]+")</span>":"";var h=$("<div class='"+n+"'>"+a.split("|").slice(e).join(" >> ")+r+"</div>").appendTo(l);e=$("#clusterTarget");e.find("#clusterChooser").remove();lc=$("<div id='clusterChooser' class='linearChooser'></div>").appendTo(e).linearchooser({data:{label:"<div>Cluster by:</div>",
list:[{label:"front",list:k},{label:"back",list:m},{label:"query",list:['<div class="innerClusterChooser">Query</div>']}],resp:[_.range(k.length),_.range(-m.length,0),["QUERY"]]}});var s=_.range(k.length).concat(_.range(-m.length,0)),t;t=b.items[a]!=="QUERY"?s.slice(b.items[a]-1)[0]:"QUERY";lc.find(".chooserSubElement").removeClass("shown");lc.find("#"+t).addClass("shown");lc.find(".chooserSubElement").click(function(u){var i=$(u.currentTarget)[0].id;if(i!=="QUERY")i=parseInt(i);$(u.currentTarget).parent().parent();
d=i!=="QUERY"?o.count(a,"|")+i+1:"QUERY";b.items[a]=d;q=v(j,f,d);var x;$.each(p.element.find(":ui-clusterelement, :ui-clusterview"),function(B,y){x=y.id.replace(/__/g," ");delete b[x];$(y).remove()});var A=w(q,b,c,g,f,o.count(a,"|"),d,p);t=b.items[a]!=="QUERY"?s.slice(b.items[a]-1)[0]:"QUERY";lc.find(".chooserSubElement").removeClass("shown");lc.find("#"+t).addClass("shown");$(root).data().statehandler.changestate();h.click(function(){A.toggle();if(h.hasClass("hide")){h.removeClass("hide");c.remove(a)}else{h.addClass("hide");
c.add(a,true)}$(root).data().statehandler.changestate()})});d=b.items[a]||0;n=c.items[a]||false;q=v(j,f,d);var z=w(q,b,c,g,f,o.count(a,"|"),d,p);n===true&&z.hide();h.click(function(){z.toggle();if(h.hasClass("hide")){h.removeClass("hide");c.remove(a)}else{h.addClass("hide");c.add(a,true)}$(root).data().statehandler.changestate()})},destroy:function(){this.element.empty()}})});