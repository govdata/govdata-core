define(["jquery","jquery-ui","jquery-ui.extensions","ui.linearchooser","ui.clusterview"],function(){facet_computer=function(k){k=k.facet_fields;var h={},f=k.sourceSpec,g,i=f.length/2,d,e;$.each(_.range(i),function(b){d=f[2*b];e=f[2*b+1];g=JSON.parse(d);var j;$.each(_.keys(g),function(n){j=_.values(g).slice(0,n+1).join("|");h[j]=(h[j]||0)+e})});var l=k.dateDivisionsTight;i=l.length/2;var m=[];$.each(_.range(i),function(b){d=l[2*b];e=l[2*b+1];dateNames=d.split(" ");$.each(dateNames,function(j,n){if(e>
0){h[n]=(h[n]||0)+e;m.push(n)}})});m=_.uniq(m);var c=k.spatialDivisionsTight;i=c.length/2;var a=[];$.each(_.range(i),function(b){d=c[2*b];e=c[2*b+1];if(e>0&d!=="Undefined"){h[d]=(h[d]||0)+e;a.push(d)}});a=_.uniq(a);return{facet_dict:h,spatialDivisions:a,dateDivisions:m}};$.widget("ui.resultsview",{options:{dataHandler:undefined,resultsRenderer:undefined,key:" "},_init:function(){this.listenTo(this.options.dataHandler,"newResults",this.newResults)},newResults:function(){var k=this.options.dataHandler.docs,
h=this.options.dataHandler.metadata,f=this.options.query,g=facet_computer(this.options.dataHandler.facet_counts),i=g.facet_dict,d=g.spatialDivisions,e=g.dateDivisions;g=_.map(e,function(a){return'<div class="innerDateChooser"><span class="value">'+a+'</span><span class="facet">'+i[a]+"</span></div>"});var l=_.map(d,function(a){return'<div class="innerSpaceChooser"><span class="value">'+a+'</span><span class="facet">'+i[a]+"</span></div>"}),m=this.options.dataHandler.numFound;$("#subHeader").find("#filterBar").remove();
var c=$("<div id='filterBar'></div>").appendTo($("#subHeader"));this.element.find(".numFound").remove();$("<div class='numFound' id='totalNumFound'><div id='innerNumFound' style='font-size:30px'>"+m+"</div><div>Total Slices</div></div>").appendTo(c);$('<div class="filterSeparator"></div>').appendTo(c);this.element.find(".linearChooser").remove();if(g.length>0){$("<div class='linearChooser' id='dateChooser'></div>").appendTo(c).linearchooser({data:{label:"<div style='width:120px'>Filter date by:</div>",
list:[{label:"date",list:g}]}}).find(".chooserSubElement").click(function(a){a=parseInt($(a.currentTarget)[0].id);var b=f.filteritems,j=f.items;b.push('dateDivisionsTight:"'+e[a]+'"');f.update({qval:j,fqval:b});$(root).data().statehandler.changestate()});$('<div class="filterSeparator"></div>').appendTo(c)}if(l.length>0){$("<div class='linearChooser' id='spaceChooser'></div>").appendTo(c).linearchooser({data:{label:"<div style='width:120px'>Filter space by:</div>",list:[{label:"space",list:l}]}}).find(".chooserSubElement").click(function(a){a=
parseInt($(a.currentTarget)[0].id);var b=f.filteritems,j=f.items;b.push('spatialDivisionsTight:"'+d[a]+'"');f.update({qval:j,fqval:b});$(root).data().statehandler.changestate()});$('<div class="filterSeparator"></div>').appendTo(c)}c.find(".clusterTarget").remove();$("<div id='clusterTarget'></div>").appendTo(c);this.element.find("hr").remove();$("<hr/>").appendTo(c);this.element.find(".clusterView").remove();$("<div class='clusterView' id='__'></div>").appendTo(this.element).clusterview({data:k,
metadata:h,resultsRenderer:this.options.resultsRenderer,collapsedict:this.options.collapsedict,key:this.options.key,hidedict:this.options.hidedict,facet_dict:i}).data("clusterview")}})});